<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TfL Live Tube Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin: 0; padding: 0; }
    .leaflet-popup-content { font-size: 14px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([51.5074, -0.1278], 12); // London center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let markers = {};

    function fetchPositions() {
      // optionally pass lines via ?lines=central,victoria
      fetch('/positions')
        .then(r => r.json())
        .then(data => {
          // remove old markers not present any more
          const newKeys = new Set(data.map(d => d.naptanId + '|' + d.expectedArrival + '|' + (d.platformName||'')));
          for (const k of Object.keys(markers)) {
            if (!newKeys.has(k)) {
              map.removeLayer(markers[k]);
              delete markers[k];
            }
          }

          data.forEach(item => {
            if (item.error) return;
            const key = item.naptanId + '|' + item.expectedArrival + '|' + (item.platformName||'');
            const lat = item.lat;
            const lon = item.lon;
            if (lat == null || lon == null) return;
            const popup = `<b>${item.lineId.toUpperCase()}</b> → ${item.destinationName}<br/>
                           Station: ${item.stationName} ${item.platformName ? ('<br/>Platform: ' + item.platformName) : ''}<br/>
                           ETA: ${item.expectedArrival ? new Date(item.expectedArrival).toLocaleTimeString() : 'n/a'}<br/>
                           ${item.timeToStation != null ? Math.round(item.timeToStation) + 's' : ''}`;
            if (markers[key]) {
              markers[key].setLatLng([lat, lon]);
              markers[key].setPopupContent(popup);
            } else {
              const m = L.circleMarker([lat, lon], { radius: 6, color: '#d00', fillOpacity: 0.9 });
              m.bindPopup(popup);
              m.addTo(map);
              markers[key] = m;
            }
          });
        })
        .catch(err => {
          console.error("positions fetch error", err);
        });
    }

    // initial fetch and interval
    fetchPositions();
    setInterval(fetchPositions, 8000);
  </script>
</body>
</html>
